<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>WinWhatsApp 98 - Analysis Suite</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>

<div class="window main-window">
    <div class="title-bar">
        <div class="title-bar-text">WinWhatsApp Stats v5.0</div>
        <div class="title-bar-controls">
            <button aria-label="Minimize"></button>
            <button aria-label="Maximize"></button>
            <button aria-label="Close"></button>
        </div>
    </div>

    <div class="window-body">
        <div class="window" style="margin-bottom: 15px;">
            <div class="window-body file-zone">
                <p>S√©lectionnez votre export WhatsApp (.txt) :</p>
                <input type="file" id="fileInput" accept=".txt" style="display:none">
                <button id="btnUpload">Choisir un fichier</button>
                <span id="fileName" style="margin-left:10px; font-style:italic;">Aucun fichier</span>
                <p id="status" style="margin-top:5px;">Statut: Pr√™t.</p>
            </div>
        </div>

        <div id="results" class="hidden">
            <menu role="tablist">
                <button class="tab-btn active" data-target="pane-dash">Dashboard</button>
                <button class="tab-btn" data-target="pane-profiles">Profiles</button>
                <button class="tab-btn" data-target="pane-heat">Heatmap</button>
                <button class="tab-btn" data-target="pane-podium">Podium</button>
            </menu>

            <div class="window tab-content">
                <div class="window-body">
                    
                    <div class="tab-pane" id="pane-dash">
                        <fieldset>
                            <legend>Global Metrics</legend>
                            <div id="globalMetrics" style="line-height: 1.5;"></div>
                        </fieldset>
                        <div class="canvas-container" style="margin-top:10px;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>

                    <div class="tab-pane hidden" id="pane-profiles">
                        <div class="tabs-nested">
                            <p>Cliquez sur un membre :</p>
                            <menu role="tablist" id="userTabsList" style="flex-wrap: wrap; gap: 2px;"></menu>
                            <div id="userPaneContent" style="padding: 15px; border: 1px solid #808080; background: #fff; margin-top:5px; min-height: 150px;">
                                <i>S√©lectionnez un utilisateur pour voir ses stats.</i>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane hidden" id="pane-heat">
                        <div id="activityHeatmap" style="background:white; color: black; border: 1px solid #808080; padding: 5px;"></div>
                        <p style="font-size: 10px; color: #555; margin-top: 5px;">* Les zones plus fonc√©es indiquent les pics d'activit√©.</p>
                    </div>

                    <div class="tab-pane hidden" id="pane-podium">
                        <div class="field-row" style="margin-bottom:10px;">
                            <label for="podiumSelector">Classer par :</label>
                            <select id="podiumSelector" style="width: 150px;">
                                <option value="Messages">Top Messages</option>
                                <option value="Variety">Top Mots/Msg</option>
                                <option value="Shouts">Top Cris (!)</option>
                            </select>
                        </div>
                        <fieldset>
                            <legend>Classement des 5 meilleurs</legend>
                            <ul id="podiumContent" class="podium-list"></ul>
                        </fieldset>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="engine.js"></script>

<script>
    const ui = {
        pieChartInst: null,

        init() {
            // Mapping des boutons
            document.getElementById('btnUpload').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('fileInput').onchange = (e) => this.handleFile(e);
            
            // Switch d'onglets
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => this.switchTab(btn);
            });

            // Changement de crit√®re podium
            document.getElementById('podiumSelector').onchange = () => this.renderPodium();
        },

        handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('status').innerText = "Analyse en cours...";
            
            const engine = new RetroEngine();
            engine.loadFile(file, () => {
                window.engine = engine;
                document.getElementById('status').innerText = "Analyse termin√©e !";
                document.getElementById('results').classList.remove('hidden');
                this.renderAll();
            });
        },

        switchTab(btn) {
            // UI des boutons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Visibilit√© des panneaux
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(btn.dataset.target);
            if (target) target.classList.remove('hidden');
        },

        renderAll() {
            this.renderGlobal();
            this.renderPie();
            this.renderUserProfiles();
            this.renderHeatmap();
            this.renderPodium();
        },

        renderGlobal() {
            const stats = window.engine.getGlobalStats();
            document.getElementById('globalMetrics').innerHTML = `
                ‚Ä¢ <b>Volume Total :</b> ${stats.total} messages analys√©s<br>
                ‚Ä¢ <b>Contenu M√©dia :</b> ${stats.media} (images/vid√©os/audios)<br>
                ‚Ä¢ <b>Dur√©e de la conversation :</b> ${stats.timespan} jours
            `;
        },

        renderPie() {
            const counts = window.engine.getMsgsPerUser();
            const ctx = document.getElementById('pieChart');
            
            if (this.pieChartInst) this.pieChartInst.destroy();

            this.pieChartInst = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{ 
                        data: Object.values(counts), 
                        backgroundColor: ['#000080', '#800000', '#008000', '#808000', '#008080'],
                        borderWidth: 1,
                        borderColor: '#000'
                    }]
                },
                options: { 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { 
                            display: true, 
                            text: 'R√âPARTITION DU VOLUME PAR MEMBRE', 
                            font: { size: 14, weight: 'bold' } 
                        }
                    }
                }
            });
        },

        renderUserProfiles() {
            const list = document.getElementById('userTabsList');
            const content = document.getElementById('userPaneContent');
            list.innerHTML = '';
            
            window.engine.users.forEach((user, i) => {
                const btn = document.createElement('button');
                btn.innerText = user;
                btn.onclick = () => {
                    const s = window.engine.getUserStats(user);
                    content.innerHTML = `
                        <h4 style="margin-top:0; color: #000080;">${user}</h4>
                        <hr>
                        <div style="line-height: 1.8;">
                            ‚Ä¢ <b>Messages envoy√©s :</b> ${s.total}<br>
                            ‚Ä¢ <b>Moyenne de mots par message :</b> ${s.avgWords}<br>
                            ‚Ä¢ <b>Utilisation de points d'exclamation (!) :</b> ${s.shouts}<br>
                            ‚Ä¢ <b>Activit√© nocturne (0h-6h) :</b> ${s.nightOwl} messages
                        </div>
                    `;
                    list.querySelectorAll('button').forEach(b => b.style.fontWeight = 'normal');
                    btn.style.fontWeight = 'bold';
                };
                list.appendChild(btn);
                if(i === 0) btn.click();
            });
        },

        renderHeatmap() {
            const data = window.engine.getHeatmapData();
            const chartDiv = document.getElementById('activityHeatmap');
            chartDiv.innerHTML = ''; 

            new ApexCharts(chartDiv, {
                series: data,
                chart: { type: 'heatmap', height: 320, toolbar: {show: false} },
                plotOptions: {
                    heatmap: {
                        shadeIntensity: 0.5,
                        colorScale: { 
                            ranges: [
                                { from: 0, to: 0, color: '#f0f0f0' }, 
                                { from: 1, to: 10000, color: '#000080' }
                            ] 
                        }
                    }
                },
                dataLabels: { enabled: false },
                title: { text: 'PIC D\'ACTIVIT√â (HEURES VS JOURS)', align: 'center' },
                xaxis: { title: { text: 'Heures' } },
                yaxis: { title: { text: 'Jours de la semaine' } }
            }).render();
        },

        renderPodium() {
            const crit = document.getElementById('podiumSelector').value;
            const ranking = window.engine.getRanking(crit);
            document.getElementById('podiumContent').innerHTML = ranking.map((r, i) => {
                const medal = i === 0 ? 'ü•á ' : i === 1 ? 'ü•à ' : i === 2 ? 'ü•â ' : '‚Ä¢ ';
                return `<li>${medal}${r.user} : <b>${r.score}</b></li>`;
            }).join('');
        }
    };

    ui.init();
</script>
</body>
</html>
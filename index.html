<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>WinWhatsApp 98 - Analysis Suite</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>

<div class="window main-window">
    <div class="title-bar">
        <div class="title-bar-text">WinWhatsApp Stats v5.0 - Web Analyzer</div>
        <div class="title-bar-controls">
            <button aria-label="Minimize"></button>
            <button aria-label="Maximize"></button>
            <button aria-label="Close"></button>
        </div>
    </div>

    <div class="window-body">
        <div class="window" style="margin-bottom: 15px;">
            <div class="window-body file-zone">
                <p>Sélectionnez votre export WhatsApp (.txt) :</p>
                <input type="file" id="fileInput" accept=".txt" style="display:none">
                <button id="btnUpload">Choisir un fichier</button>
                <span id="fileName" style="margin-left:10px; font-style:italic;">Aucun fichier choisi</span>
                <p id="status" style="margin-top:5px;">Statut: Prêt.</p>
            </div>
        </div>

        <div id="results" class="hidden">
            <menu role="tablist">
                <button class="tab-btn active" data-target="pane-dash">Dashboard</button>
                <button class="tab-btn" data-target="pane-profiles">Profiles</button>
                <button class="tab-btn" data-target="pane-heat">Heatmap</button>
                <button class="tab-btn" data-target="pane-podium">Podium</button>
            </menu>

            <div class="window tab-content">
                <div class="window-body">
                    
                    <div class="tab-pane" id="pane-dash">
                        <fieldset>
                            <legend>Global Metrics</legend>
                            <div id="globalMetrics" style="line-height: 1.5;"></div>
                        </fieldset>
                        <div class="canvas-container" style="margin-top:10px; height: 300px;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>

                    <div class="tab-pane hidden" id="pane-profiles">
                        <div class="tabs-nested">
                            <p>Membres détectés :</p>
                            <menu role="tablist" id="userTabsList" style="flex-wrap: wrap; gap: 2px; margin-bottom: 10px;"></menu>
                            <div id="userPaneContent" style="padding: 15px; border: 1px solid #808080; background: #fff; min-height: 200px; color: black; overflow-y: auto;">
                                <i>Sélectionnez un membre.</i>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane hidden" id="pane-heat">
                        <div id="activityHeatmap" style="background:white; color: black; border: 1px solid #808080; padding: 5px;"></div>
                        <p style="font-size: 10px; color: #555; margin-top: 5px;">* Plus la case est foncée, plus l'activité a été intense.</p>
                    </div>

                    <div class="tab-pane hidden" id="pane-podium">
                        <div class="field-row" style="margin-bottom:10px;">
                            <label>Classer par :</label>
                            <select id="podiumSelector" style="width: 180px;">
                                <option value="Messages">Volume de messages</option>
                                <option value="Variety">Moyenne de mots/msg</option>
                                <option value="Shouts">Cris et Excitation (!)</option>
                                <option value="Caps">FULL MAJUSCULES</option>
                            </select>
                        </div>
                        <fieldset>
                            <legend>Top 5 des contributeurs</legend>
                            <ul id="podiumContent" class="podium-list"></ul>
                        </fieldset>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="engine.js"></script>
<script>
    const ui = {
        pieChartInst: null,

        init() {
            document.getElementById('btnUpload').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('fileInput').onchange = (e) => this.handleFile(e);
            document.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = () => this.switchTab(btn));
            document.getElementById('podiumSelector').onchange = () => this.renderPodium();
        },

        handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('status').innerText = "Traitement...";
            const engine = new RetroEngine();
            engine.loadFile(file, () => {
                window.engine = engine;
                document.getElementById('status').innerText = "Terminé !";
                document.getElementById('results').classList.remove('hidden');
                this.renderAll();
            });
        },

        switchTab(btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById(btn.dataset.target).classList.remove('hidden');
        },

        renderAll() {
            this.renderGlobal();
            this.renderPie();
            this.renderUserProfiles();
            this.renderHeatmap();
            this.renderPodium();
        },

        renderGlobal() {
            const s = window.engine.getGlobalStats();
            document.getElementById('globalMetrics').innerHTML = `
                • <b>Messages :</b> ${s.total}<br>
                • <b>Médias :</b> ${s.media}<br>
                • <b>Jours :</b> ${s.timespan}
            `;
        },

        renderPie() {
            const counts = window.engine.getMsgsPerUser();
            const labels = Object.keys(counts);
            // Génération de couleurs dynamiques (une par personne)
            const colors = labels.map((_, i) => `hsl(${(i * 360) / labels.length}, 70%, 45%)`);
            
            if (this.pieChartInst) this.pieChartInst.destroy();
            this.pieChartInst = new Chart(document.getElementById('pieChart'), {
                type: 'pie',
                data: { labels, datasets: [{ data: Object.values(counts), backgroundColor: colors }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        },

        renderUserProfiles() {
            const list = document.getElementById('userTabsList');
            const content = document.getElementById('userPaneContent');
            list.innerHTML = '';
            window.engine.users.forEach((user, i) => {
                const btn = document.createElement('button');
                btn.innerText = user;
                btn.onclick = () => {
                    const s = window.engine.getUserStats(user);
                    // On construit la liste des messages répétés (doublons)
                    const reps = s.repeats.slice(0, 5).map(r => `<li>"${r[0].substring(0,30)}..." <b>(x${r[1]})</b></li>`).join('');
                    
                    content.innerHTML = `
                        <h4 style="margin:0; color:#000080;">${user}</h4><hr>
                        • Total msgs : <b>${s.total}</b><br>
                        • Messages en MAJ : <b>${s.caps}</b><br>
                        • Mots/msg : <b>${s.avgWords}</b> | • Cris (!) : <b>${s.shouts}</b><br><br>
                        <strong>Top Répétitions (Tics) :</strong>
                        <ul style="margin-top:5px; font-size:11px;">${reps || "Aucune répétition"}</ul>
                    `;
                    list.querySelectorAll('button').forEach(b => b.style.fontWeight = 'normal');
                    btn.style.fontWeight = 'bold';
                };
                list.appendChild(btn);
                if(i === 0) btn.click();
            });
        },

        renderHeatmap() {
            const data = window.engine.getHeatmapData();
            const chartDiv = document.getElementById('activityHeatmap');
            chartDiv.innerHTML = '';
            new ApexCharts(chartDiv, {
                series: data,
                chart: { type: 'heatmap', height: 350, toolbar: {show:false} },
                plotOptions: { heatmap: { colorScale: { min:0, colors: [{from:0, to:0, color:'#f0f0f0'}] } } },
                colors: ["#000080"],
                title: { text: 'INTENSITÉ PAR HEURE' }
            }).render();
        },

        renderPodium() {
            const crit = document.getElementById('podiumSelector').value;
            const ranking = window.engine.getRanking(crit);
            document.getElementById('podiumContent').innerHTML = ranking.map((r, i) => 
                `<li>${i+1}. ${r.user} : <b>${r.score}</b></li>`
            ).join('');
        }
    };
    ui.init();
</script>
</body>
</html>